<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard ESP32</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 800px; margin: 24px auto; padding: 0 12px; }
    h1 { margin-bottom: 8px; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 16px; margin: 12px 0; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
    .val { font-size: 22px; font-weight: 600; }
    button { padding: 8px 12px; margin: 4px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    code { background: #f6f8fa; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>üì° Dashboard ESP32</h1>

  <div class="card">
    <h2>D·ªØ li·ªáu c·∫£m bi·∫øn</h2>
    <div class="grid">
      <div> Nhi·ªát ƒë·ªô: <span id="nhietdo" class="val">--</span> ¬∞C</div>
      <div> ƒê·ªô ·∫©m: <span id="doam" class="val">--</span> %</div>
      <div> √Ånh s√°ng: <span id="anhSang" class="val">--</span> lx</div>
    </div>
  </div>

  <div class="card">
    <h2>Tr·∫°ng th√°i thi·∫øt b·ªã</h2>
    <div class="grid">
      <div> ƒê√®n 1: <span id="led1" class="val">--</span></div>
      <div> ƒê√®n 2: <span id="led2" class="val">--</span></div>
      <div> Qu·∫°t: <span id="fan" class="val">--</span></div>
      <div> R√®m (mode): <span id="curtain" class="val">--</span></div>
    </div>
  </div>

  <div class="card">
    <h2>ƒêi·ªÅu khi·ªÉn</h2>
    <div class="row">
      <div>
        <div>ƒê√®n 1</div>
        <button onclick="sendCmd('home/cmd/led1','ON')">B·∫≠t</button>
        <button onclick="sendCmd('home/cmd/led1','OFF')">T·∫Øt</button>
      </div>
      <div>
        <div>ƒê√®n 2</div>
        <button onclick="sendCmd('home/cmd/led2','ON')">B·∫≠t</button>
        <button onclick="sendCmd('home/cmd/led2','OFF')">T·∫Øt</button>
      </div>
      <div>
        <div>Qu·∫°t</div>
        <button onclick="sendCmd('home/cmd/fan','ON')">B·∫≠t</button>
        <button onclick="sendCmd('home/cmd/fan','OFF')">T·∫Øt</button>
      </div>
      <div>
        <div>R√®m</div>
        <button onclick="sendCmd('home/cmd/curtain','OPEN')">M·ªü</button>
        <button onclick="sendCmd('home/cmd/curtain','CLOSE')">ƒê√≥ng</button>
        <button onclick="sendCmd('home/cmd/curtain','STOP')">D·ª´ng</button>
      </div>
    </div>
    <p><small>MQTT topics v√≠ d·ª•: <code>home/cmd/led1</code>, <code>home/cmd/fan</code>, <code>home/cmd/curtain</code></small></p>
  </div>

  <script>
    async function fetchJSON(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    async function loadSensors() {
      try {
        const d = await fetchJSON('/api/cambien/latest');
        document.getElementById('nhietdo').textContent = d?.nhietdo ?? '--';
        document.getElementById('doam').textContent = d?.doam ?? '--';
        document.getElementById('anhSang').textContent = d?.anhSang ?? '--';
      } catch (e) {
        console.warn('Sensors error:', e.message);
      }
    }

    async function loadStatus() {
      try {
        const s = await fetchJSON('/api/trangthai/latest');
        document.getElementById('led1').textContent = s?.led1 ? 'ON' : 'OFF';
        document.getElementById('led2').textContent = s?.led2 ? 'ON' : 'OFF';
        document.getElementById('fan').textContent = s?.fan ? 'ON' : 'OFF';
        document.getElementById('curtain').textContent =
          Number.isInteger(s?.curtainMode) ? s.curtainMode : '--';
      } catch (e) {
        console.warn('Status error:', e.message);
      }
    }

    async function sendCmd(topic, cmd) {
      try {
        await fetch('/api/cmd', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ topic, cmd })
        });
      } catch (e) {
        alert('L·ªói g·ª≠i l·ªánh: ' + e.message);
      }
    }

    loadSensors();
    loadStatus();
    setInterval(loadSensors, 2000);
    setInterval(loadStatus, 2000);
  </script>
</body>
</html>
