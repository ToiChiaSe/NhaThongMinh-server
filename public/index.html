<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Smart Home Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f6f9; }
    h1 { color: #2c3e50; text-align: center; }

    .card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
    }

    .card h2 {
      margin-top: 0;
      color: #34495e;
      border-bottom: 1px solid #ddd;
      padding-bottom: 8px;
    }

    .sensor p, .status p {
      font-size: 16px;
      margin: 6px 0;
    }

    .control-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 10px 0;
    }

    /* Toggle switch style */
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    .switch input { display: none; }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 18px; width: 18px;
      left: 3px; bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #3498db;
    }
    input:checked + .slider:before {
      transform: translateX(26px);
    }

    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #ecf0f1; }
  </style>
</head>
<body>
  <h1> Smart Home Dashboard</h1>

  <div class="card sensor">
    <h2>Thông số cảm biến</h2>
    <p> Nhiệt độ: <span id="nhietdo">--</span> °C</p>
    <p> Độ ẩm: <span id="doam">--</span> %</p>
    <p> Ánh sáng: <span id="anhSang">--</span> lux</p>
  </div>

  <div class="card status">
    <h2>Trạng thái thiết bị</h2>
    <p>LED1: <span id="led1">--</span></p>
    <p>LED2: <span id="led2">--</span></p>
    <p>LED3: <span id="led3">--</span></p>
    <p>LED4: <span id="led4">--</span></p>
    <p>Quạt: <span id="fan">--</span></p>
    <p>Rèm: <span id="curtainMode">--</span></p>
  </div>

  <div class="card controls">
    <h2>Điều khiển thiết bị</h2>
    <div class="control-item">
      <span>LED1</span>
      <label class="switch">
        <input type="checkbox" onchange="toggleDevice(this,'truong/home/cmd/led1')">
        <span class="slider"></span>
      </label>
    </div>
    <div class="control-item">
      <span>LED2</span>
      <label class="switch">
        <input type="checkbox" onchange="toggleDevice(this,'truong/home/cmd/led2')">
        <span class="slider"></span>
      </label>
    </div>
    <div class="control-item">
      <span>LED3</span>
      <label class="switch">
        <input type="checkbox" onchange="toggleDevice(this,'truong/home/cmd/led3')">
        <span class="slider"></span>
      </label>
    </div>
    <div class="control-item">
      <span>LED4</span>
      <label class="switch">
        <input type="checkbox" onchange="toggleDevice(this,'truong/home/cmd/led4')">
        <span class="slider"></span>
      </label>
    </div>
    <div class="control-item">
      <span>Quạt</span>
      <label class="switch">
        <input type="checkbox" onchange="toggleDevice(this,'truong/home/cmd/fan')">
        <span class="slider"></span>
      </label>
    </div>
    <div class="control-item">
      <span>Rèm</span>
      <label class="switch">
        <input type="checkbox" onchange="toggleCurtain(this)">
        <span class="slider"></span>
      </label>
    </div>
  </div>

  <div class="card report">
    <h2>Báo cáo thống kê (10 bản ghi gần nhất)</h2>
    <table id="reportTable">
      <thead>
        <tr><th>Thời gian</th><th>Nhiệt độ</th><th>Độ ẩm</th><th>Ánh sáng</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    async function fetchData() {
      const s = await (await fetch('/api/cambien/latest')).json();
      document.getElementById('nhietdo').textContent = s?.nhietdo ?? '--';
      document.getElementById('doam').textContent = s?.doam ?? '--';
      document.getElementById('anhSang').textContent = s?.anhSang ?? '--';

      const t = await (await fetch('/api/trangthai/latest')).json();
      document.getElementById('led1').textContent = t?.led1 ? 'ON' : 'OFF';
      document.getElementById('led2').textContent = t?.led2 ? 'ON' : 'OFF';
      document.getElementById('led3').textContent = t?.led3 ? 'ON' : 'OFF';
      document.getElementById('led4').textContent = t?.led4 ? 'ON' : 'OFF';
      document.getElementById('fan').textContent = t?.fan ? 'ON' : 'OFF';
      document.getElementById('curtainMode').textContent = t?.curtainMode ?? '--';
    }

    async function sendCmd(topic, cmd) {
      await fetch('/api/cmd', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ topic, cmd })
      });
    }

    function toggleDevice(el, topic) {
      const cmd = el.checked ? "ON" : "OFF";
      sendCmd(topic, cmd);
    }

    function toggleCurtain(el) {
      const cmd = el.checked ? "OPEN" : "CLOSE";
      sendCmd("truong/home/cmd/curtain", cmd);
    }

    async function fetchReport() {
      const res = await fetch('/api/cambien/recent');
      const docs = await res.json();
      const tbody = document.querySelector('#reportTable tbody');
      tbody.innerHTML = "";
      docs.forEach(d => {
        const row = `
          <tr>
            <td>${new Date(d.createdAt).toLocaleString()}</td>
            <td>${d.nhietdo ?? '--'}</td>
            <td>${d.doam ?? '--'}</td>
            <td>${d.anhSang ?? '--'}</td>
          </tr>
        `;
        tbody.innerHTML += row;
      });
    }

    setInterval(() => {
      fetchData();
      fetchReport();
    }, 2000);

    fetchData();
    fetchReport();
  </script>
</body>
</html>
