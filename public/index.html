<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Smart Home Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { color: #2c3e50; }
    .sensor, .status, .controls, .report { margin-bottom: 20px; }
    button { margin: 5px; padding: 10px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  </style>
</head>
<body>
  <h1>Smart Home Dashboard</h1>

  <div class="sensor">
    <h2>Thông số cảm biến</h2>
    <p>Nhiệt độ: <span id="nhietdo">--</span> °C</p>
    <p>Độ ẩm: <span id="doam">--</span> %</p>
    <p>Ánh sáng: <span id="anhSang">--</span> lux</p>
  </div>

  <div class="status">
    <h2>Trạng thái thiết bị</h2>
    <p>LED1: <span id="led1">--</span></p>
    <p>LED2: <span id="led2">--</span></p>
    <p>Quạt: <span id="fan">--</span></p>
    <p>Rèm: <span id="curtainMode">--</span></p>
  </div>

  <div class="controls">
    <h2>Điều khiển</h2>
    <button onclick="sendCmd('home/cmd/led1','ON')">Bật LED1</button>
    <button onclick="sendCmd('home/cmd/led1','OFF')">Tắt LED1</button>
    <button onclick="sendCmd('home/cmd/led2','ON')">Bật LED2</button>
    <button onclick="sendCmd('home/cmd/led2','OFF')">Tắt LED2</button>
    <button onclick="sendCmd('home/cmd/fan','ON')">Bật Quạt</button>
    <button onclick="sendCmd('home/cmd/fan','OFF')">Tắt Quạt</button>
    <button onclick="sendCmd('home/cmd/curtain','OPEN')">Mở Rèm</button>
    <button onclick="sendCmd('home/cmd/curtain','CLOSE')">Đóng Rèm</button>
  </div>

  <div class="report">
    <h2>Báo cáo thống kê (10 bản ghi gần nhất)</h2>
    <table id="reportTable">
      <thead>
        <tr><th>Thời gian</th><th>Nhiệt độ</th><th>Độ ẩm</th><th>Ánh sáng</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    async function fetchData() {
      const s = await (await fetch('/api/cambien/latest')).json();
      document.getElementById('nhietdo').textContent = s?.nhietdo ?? '--';
      document.getElementById('doam').textContent = s?.doam ?? '--';
      document.getElementById('anhSang').textContent = s?.anhSang ?? '--';

      const t = await (await fetch('/api/trangthai/latest')).json();
      document.getElementById('led1').textContent = t?.led1 ? 'ON' : 'OFF';
      document.getElementById('led2').textContent = t?.led2 ? 'ON' : 'OFF';
      document.getElementById('fan').textContent = t?.fan ? 'ON' : 'OFF';
      document.getElementById('curtainMode').textContent = t?.curtainMode ?? '--';
    }

    async function sendCmd(topic, cmd) {
      await fetch('/api/cmd', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ topic, cmd })
      });
    }

    // Báo cáo thống kê: hiển thị 10 bản ghi gần nhất
    async function fetchReport() {
      const res = await fetch('/api/cambien/recent');
      const docs = await res.json();

      const tbody = document.querySelector('#reportTable tbody');
      tbody.innerHTML = "";
      docs.forEach(d => {
        const row = `
          <tr>
            <td>${new Date(d.createdAt).toLocaleString()}</td>
            <td>${d.nhietdo ?? '--'}</td>
            <td>${d.doam ?? '--'}</td>
            <td>${d.anhSang ?? '--'}</td>
          </tr>
        `;
        tbody.innerHTML += row;
      });
    }

    // Refresh dữ liệu mỗi 2 giây
    setInterval(() => {
      fetchData();
      fetchReport();
    }, 2000);

    // Lần đầu load
    fetchData();
    fetchReport();
  </script>
</body>
</html>
